---
title: "Data Question 4 Extension: Flexdashboard"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    theme: lumen
    social: menu
    source: embed
---

```{r setup, include=FALSE, message = FALSE, warning = FALSE, echo=FALSE}
library("flexdashboard")
library("tidyverse")
library("readxl")
library("dplyr")
library("magrittr")
library("ggplot2")
library("GGally")
library("broom")
library("plyr")
library("ggmap")
library("maps")
library("mapdata")
library("rgeos")
library("maptools")
library("sp")
library("raster")
library("rgdal")
library("sf")
library("broom")
library("stringr")

irs <- read.csv("data/irs_avg.csv")
edu_raw <- read.csv("data/achievement_profile_data_with_CORE.csv")
merged_irs <- read.csv("data/merged.csv")
edu_act <- read.csv("data/edu_act.csv")
total_sal_2014 <- read.csv("data/total_sal_2014.csv")
usa <- map_data("usa")
states <- map_data("state")
tn_df <- subset(states, region == "tennessee")
counties <- map_data("county")
tn_counties <- subset(counties, region == "tennessee")
```

Column {data-width=650}
-----------------------------------------------------------------------

### Averaged Salary by County

```{r}
total_sal_2014$sal_avg_z <- round((total_sal_2014$salary_avg - mean(total_sal_2014$salary_avg,na.rm=TRUE))/sd(total_sal_2014$salary_avg,na.rm=TRUE), 2)  # compute normalized mpg
total_sal_2014$sal_type <- ifelse(total_sal_2014$sal_avg_z < 0, 'below', 'above')  # above / below avg flag
total_sal_2014 <- total_sal_2014[order(total_sal_2014$sal_avg_z), ]  # sort
total_sal_2014$county <- factor(total_sal_2014$county, levels = total_sal_2014$county)  # convert to factor to retain sorted order in plot.

# Diverging Barcharts

ggplot(total_sal_2014, aes(x=county, y=sal_avg_z, label=sal_avg_z)) +
   geom_bar(stat='identity', aes(fill=sal_type), width=.5)  +
   scale_fill_manual(name='Average Salary',
                     labels = c('Above Average', 'Below Average'),
                     values = c('above'='#00ba38', 'below'='#f8766d')) +
   labs(subtitle='Divering Bar Plot',
        title= 'Normalised Average Salary for Counties') +
   coord_flip()

```

### Correlation Matric of Core Education Data

```{r}

edu_2 <- dplyr::select(edu_raw, system_name,BioI,Chemistry,ELA,EngI,EngII,EngIII,AlgI,AlgII,Math,Science,ACT_Composite,Graduation,Pct_Native_American,Pct_SWD,
                Pct_Black,Pct_Hispanic,Pct_EL,Pct_ED,Pct_BHN,Pct_Chronically_Absent,
                Pct_Suspended,Pct_Expelled,Per_Pupil_Expenditures,Enrollment
)
ggcorr(edu_2)

```

Column {.tabset}
-----------------------------------------------------------------------

### Per Pupil Expenditure

```{r fig.width=10, fig.height=5}

tn_base <- ggplot(data = tn_df, mapping = aes(x = long, y = lat, group = group)) + 
  coord_fixed(1.3) + 
  geom_polygon(color = "black", fill = "gray")

#I need to be able to merge these two to create the ggmap

core <- read.csv("data/merged_county.csv")
colnames(core)[2] <- "subregion" #renaming to match
core[[2]] <- tolower(core[[2]]) #changing to all lowercase

#removing 'county' from the column

core$subregion <- gsub(" county$", "", core$subregion)
tn_counties$subregion <- replace(tn_counties$subregion, tn_counties$subregion=="de kalb", "dekalb")

#merging the two dataframes together with nnner_join

tn_core <- inner_join(tn_counties, core, by = "subregion")

#Attempting to plot

ditch_the_axes <- theme(
  axis.text = element_blank(),
  axis.line = element_blank(),
  axis.ticks = element_blank(),
  panel.border = element_blank(),
  panel.grid = element_blank(),
  axis.title = element_blank()
)

tn_per_pupil <- tn_base + 
  geom_polygon(data = tn_core, aes(fill = Per_Pupil_Expenditures), color = "white") +
  geom_polygon(color = "black", fill = NA) +
  theme_bw() +
  ditch_the_axes

tn_per_pupil

```

### Graduation Rates

```{r echo=FALSE, fig.width=10, fig.height=5}
tn_graduation <- tn_base + 
  geom_polygon(data = tn_core, aes(fill = Graduation), color = "white") +
  geom_polygon(color = "black", fill = NA) +
  theme_bw() +
  ditch_the_axes

tn_graduation

```

### Dropout Rate

```{r echo=FALSE, fig.width=10, fig.height=5}
tn_dropout <- tn_base + 
  geom_polygon(data = tn_core, aes(fill = Dropout), color = "white") +
  geom_polygon(color = "black", fill = NA) +
  theme_bw() +
  ditch_the_axes

tn_dropout
```

### Percentage of Black, Hispanic, and Native American 

```{r echo=FALSE, fig.width=10, fig.height=5}
tn_per_BHN <- tn_base + 
  geom_polygon(data = tn_core, aes(fill = Pct_BHN), color = "white") +
  geom_polygon(color = "black", fill = NA) +
  theme_bw() +
  ditch_the_axes

tn_per_BHN
```